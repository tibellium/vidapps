source:
  id: "canal_rcn"
  name: "Canal RCN"
  proxy: "socks5://127.0.0.1:1080"
  country: "CO"
  language: "es"

# Discovery phase: navigate to site and extract all available channels

discovery:
  outputs:
    id: "${{find_channels.channels.id}}"
    name: "${{find_channels.channels.name}}"
    image: "${{find_channels.channels.image}}"
    expires_in: 86400 # Refresh discovery daily

  steps:
    - name: "go_home"
      kind: Navigate
      url: "https://www.canalrcn.com"
      wait_for:
        function: "localStorage.getItem('persist:tbx') && localStorage.getItem('persist:tbx').includes('access_token')"
        delay: 0.5

    - name: "find_channels"
      kind: SniffMany
      request:
        url: "tbxapis\\.com.*/items/[^/]+\\.json"
        method: GET
        idle_timeout: 3.0
      extract:
        channels:
          kind: jsonpath_array
          path: "$.result[*]"
          each:
            id: "$.id"
            name: "$.content.title"
            image: "$.content.images[?(@.type=='THUMB')].url"

# Processing phase: only include channels we care about

process:
  filter:
    name:
      - "RCN Señal en Vivo"
      - "Señal Principal"
  transforms:
    - kind: AddCategory
      name: "RCN Señal en Vivo"
      category: "General"
    - kind: AddCategory
      name: "Señal Principal"
      category: "Entretenimiento"
    - kind: AddDescription
      name: "Señal Principal"
      description: "Transmisión en vivo 24/7"

# Metadata phase: extract EPG data for all channels

metadata:
  outputs:
    programmes: "${{get_epg.programmes}}"
    expires_in: 3600 # Refresh EPG hourly

  steps:
    - name: "go_to_livetv"
      kind: Navigate
      url: "https://www.canalrcn.com/co/tv-en-vivo"

    - name: "get_epg"
      kind: Sniff
      request:
        url: "unity\\.tbxapis\\.com.*/items/.*_coco_p0_es\\.json"
        method: GET
      extract:
        programmes:
          kind: jsonpath_array
          path: "$.result[*].content.epg[*]"
          each:
            channel_id: "$parent.id"
            title: "$.title"
            description: "$.description"
            start_time: "$.startTime"
            end_time: "$.endTime"
            image: "$.images[?(@.type=='THUMB')].url"

# Content phase: for each channel, navigate to player and extract stream info

content:
  outputs:
    manifest_url: "${{get_content.mpd_url}}"
    license_url: "${{get_content.license_url}}"
    expires_at: "${{get_content.expires_at}}"

  steps:
    - name: "go_to_player"
      kind: Navigate
      url: "https://www.canalrcn.com/co/player/${{channel.id}}"

    - name: "get_content"
      kind: Sniff
      request:
        url: "unity\\.tbxapis\\.com/v0/contents/.*/url"
        method: GET
      extract:
        mpd_url:
          kind: jsonpath
          path: "$.entitlements[?(@.contentType=='application/dash+xml')].url"
        license_url:
          kind: jsonpath
          path: "$.entitlements[?(@.drm.widevine)].drm.widevine.licenseAcquisitionUrl"
        expires_at:
          kind: jsonpath_regex
          path: "$.entitlements[?(@.contentType=='application/dash+xml')].url"
          regex: "expires=(\\d+)"
