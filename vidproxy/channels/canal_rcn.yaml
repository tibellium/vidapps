channel:
  name: "Canal RCN"
  proxy: "socks5://127.0.0.1:1080"

steps:
  - name: "go_home"
    kind: Navigate
    url: "https://www.canalrcn.com"
    wait_for:
      function: "localStorage.getItem('persist:tbx') && localStorage.getItem('persist:tbx').includes('access_token')"
      delay: 0.5

  - name: "find_content"
    kind: Sniff
    request:
      url: "tbxapis\\.com.*/items/[^/]+\\.json"
      method: GET
    extract:
      content_id:
        kind: jsonpath
        path: "$.result[?(@.content.title == 'Se√±al Principal')].id"

  - name: "go_to_player"
    kind: Navigate
    url: "https://www.canalrcn.com/co/player/${{find_content.content_id}}"

  - name: "get_manifest"
    kind: Sniff
    request:
      url: "\\.mpd"
    extract:
      mpd_url:
        kind: url
      pssh:
        kind: pssh

  - name: "get_license_url"
    kind: Sniff
    request:
      url: "license.*widevine"
      method: POST
    extract:
      license_url:
        kind: url

  - name: "fetch_keys"
    kind: CdrmRequest
    pssh: "${{get_manifest.pssh}}"
    license_url: "${{get_license_url.license_url}}"
    extract:
      decryption_key:
        kind: line

outputs:
  mpd_url: "${{get_manifest.mpd_url}}"
  decryption_key: "${{fetch_keys.decryption_key}}"
