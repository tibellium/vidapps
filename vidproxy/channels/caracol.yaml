source:
  id: "caracol"
  name: "Caracol TV"
  country: "CO"
  language: "es"
  headless: false
  proxy: "socks5://127.0.0.1:1080"

# Discovery phase: open the live page and extract all available channels

discovery:
  outputs:
    id: "${{find_channels.channels.id}}"
    name: "${{find_channels.channels.name}}"
    image: "${{find_channels.channels.image}}"
    expires_in: 86400 # Refresh discovery daily

  steps:
    - name: "go_live"
      kind: Navigate
      url: "https://www.caracoltv.com/senal-vivo"
      wait_for:
        selector: "template[id^='signal-item-']"

    - name: "find_channels"
      kind: Document
      extract:
        channels:
          kind: css_array
          path: "template[id^='signal-item-']"
          each:
            id: "ps-mediastream::attr(data-video-id)"
            name: "h1.LiveStreamModule-title::text"
            image: "div.LiveStreamModule-header-logo img.Image::attr(src)"
          unescape: true

# Processing phase: rename and categorize channels

process:
  filter:
    name:
      - "Señal en vivo"
      - "Señal en vivo Noticias Caracol"
      - "Señal en vivo Blu Radio"
      - "Señal en vivo La Kalle"
  transforms:
    - kind: Rename
      name: "Señal en vivo"
      to: "Caracol - Señal Principal"
    - kind: Rename
      name: "Señal en vivo Noticias Caracol"
      to: "Caracol - Noticias"
    - kind: Rename
      name: "Señal en vivo Blu Radio"
      to: "Caracol - Blu Radio"
    - kind: Rename
      name: "Señal en vivo La Kalle"
      to: "Caracol - La Kalle"

    - kind: AddCategory
      name: "Caracol - Señal Principal"
      category: "Caracol"
    - kind: AddCategory
      name: "Caracol - Noticias"
      category: "Caracol"
    - kind: AddCategory
      name: "Caracol - Blu Radio"
      category: "Caracol"
    - kind: AddCategory
      name: "Caracol - La Kalle"
      category: "Caracol"

    - kind: AddDescription
      name: "Caracol - Señal Principal"
      description: "Transmisión en vivo 24/7"
    - kind: AddDescription
      name: "Caracol - Noticias"
      description: "Transmisión en vivo 24/7"
    - kind: AddDescription
      name: "Caracol - Blu Radio"
      description: "Transmisión en vivo 24/7"
    - kind: AddDescription
      name: "Caracol - La Kalle"
      description: "Transmisión en vivo 24/7"

# Metadata phase: extract EPG data for Caracol TV

metadata:
  outputs:
    programmes: "${{get_schedule.programmes}}"
    expires_in: 3600 # Refresh EPG hourly

  steps:
    - name: "go_live"
      kind: Navigate
      url: "https://www.caracoltv.com/senal-vivo"
      wait_for:
        selector: "template[id^='signal-item-']"

    - name: "get_ctv"
      kind: Document
      extract:
        video_id:
          kind: css
          path: "ps-mediastream[data-publicTokenEndpoint='https://ms-live.noticiascaracol.com/vide-public-token/ctv']::attr(data-video-id)"

    - name: "go_schedule"
      kind: Navigate
      url: "https://www.caracoltv.com/programacion"
      wait_for:
        selector: "div.ScheduleDay-Content-item"

    - name: "get_schedule"
      kind: Document
      extract:
        programmes:
          kind: css_array
          path: "div.ScheduleDay-Content-item"
          each:
            channel_id: "const:${{get_ctv.video_id}}"
            title: "h2.ScheduleDay-info-title a::text"
            start_time: "::attr(data-starttime)"
            end_time: "::attr(data-endtime)"
            image: "img.Image::attr(src)"
          unescape: true

# Content phase: extract stream info for each channel

content:
  outputs:
    manifest_url: "https://mdstrm.com/live-stream-playlist/${{channel.id}}.m3u8?access_token=${{get_token.access_token}}"

  steps:
    - name: "go_live"
      kind: Navigate
      url: "https://www.caracoltv.com/senal-vivo"
      wait_for:
        selector: "template[id^='signal-item-']"

    - name: "get_channel_token"
      kind: Document
      extract:
        token_url:
          kind: css
          path: "ps-mediastream[data-video-id='${{channel.id}}']::attr(data-publicTokenEndpoint)"
          default: "https://ms-live.noticiascaracol.com/vide-public-token/ctv"

    - name: "get_token_video"
      kind: Document
      extract:
        token_video_id:
          kind: css
          path: "ps-mediastream[data-publicTokenEndpoint='${{get_channel_token.token_url}}']::attr(data-video-id)"

    - name: "get_token"
      kind: FetchInBrowser
      url: "${{get_channel_token.token_url}}?id=${{get_token_video.token_video_id}}"
      extract:
        access_token:
          kind: jsonpath
          path: "$.access_token"
