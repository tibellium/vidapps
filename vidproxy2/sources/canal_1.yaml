source:
  id: "canal_1"
  name: "Canal 1"
  country: "CO"
  language: "es"

discovery:
  headless: true

  outputs:
    id: "${{get_live_json.channel_id}}"
    name: "Canal 1 - Se침al en Vivo"
    image: "${{get_image.image}}"
    expires_in: 86400

  steps:
    - name: "go_to_livetv"
      kind: Navigate
      url: "https://www.canal1.com.co/senal-en-vivo/"
      wait_for:
        selector: "script#__NEXT_DATA__"

    - name: "get_image"
      kind: Document
      extract:
        image:
          kind: css
          path: "meta[property='og:image']::attr(content)"

    - name: "get_build_id"
      kind: Document
      extract:
        build_id:
          kind: regex
          path: '(?s)<script[^>]*id="__NEXT_DATA__"[^>]*>.*?"buildId":"([^"]+)".*?</script>'

    - name: "get_live_json"
      kind: Fetch
      url: "https://www.canal1.com.co/_next/data/${{get_build_id.build_id}}/senal-en-vivo.json"
      extract:
        channel_id:
          kind: jsonpath
          path: "$.pageProps.page.extra_info.principal_signal"

process:
  transforms:
    - kind: AddCategory
      name: "Canal 1 - Se침al en Vivo"
      category: "Canal 1"
    - kind: AddDescription
      name: "Canal 1 - Se침al en Vivo"
      description: "Transmisi칩n en vivo 24/7"

metadata:
  headless: true

  outputs:
    programmes: "${{schedule_0.programmes}}"
    expires_in: 3600

  steps:
    # We need the channel ID from discovery to tag programmes
    - name: "go_to_livetv"
      kind: Navigate
      url: "https://www.canal1.com.co/senal-en-vivo/"
      wait_for:
        selector: "script#__NEXT_DATA__"

    - name: "get_build_id"
      kind: Document
      extract:
        build_id:
          kind: regex
          path: '(?s)<script[^>]*id="__NEXT_DATA__"[^>]*>.*?"buildId":"([^"]+)".*?</script>'

    - name: "get_live_json"
      kind: Fetch
      url: "https://www.canal1.com.co/_next/data/${{get_build_id.build_id}}/senal-en-vivo.json"
      extract:
        principal_signal:
          kind: jsonpath
          path: "$.pageProps.page.extra_info.principal_signal"

    # Fetch all 7 days from the public schedule API.
    # Multiple steps producing the same array name ("programmes") are merged.
    - name: "schedule_0"
      kind: Fetch
      url: "https://api.canal1.com.co/api/schedules/0"
      extract:
        programmes:
          kind: jsonpath_array
          path: "$[*]"
          each:
            channel_id: "const:${{get_live_json.principal_signal}}"
            title: "$.name"
            description: "$.descriptionShow|$.description"
            start_time: "$.dateTime"
            end_time: "$.dateFinishTime"
            image: "$.featured_image.url"
            is_live: "$.isLiveWeb"

    - name: "schedule_1"
      kind: Fetch
      url: "https://api.canal1.com.co/api/schedules/1"
      extract:
        programmes:
          kind: jsonpath_array
          path: "$[*]"
          each:
            channel_id: "const:${{get_live_json.principal_signal}}"
            title: "$.name"
            description: "$.descriptionShow|$.description"
            start_time: "$.dateTime"
            end_time: "$.dateFinishTime"
            image: "$.featured_image.url"
            is_live: "$.isLiveWeb"

    - name: "schedule_2"
      kind: Fetch
      url: "https://api.canal1.com.co/api/schedules/2"
      extract:
        programmes:
          kind: jsonpath_array
          path: "$[*]"
          each:
            channel_id: "const:${{get_live_json.principal_signal}}"
            title: "$.name"
            description: "$.descriptionShow|$.description"
            start_time: "$.dateTime"
            end_time: "$.dateFinishTime"
            image: "$.featured_image.url"
            is_live: "$.isLiveWeb"

    - name: "schedule_3"
      kind: Fetch
      url: "https://api.canal1.com.co/api/schedules/3"
      extract:
        programmes:
          kind: jsonpath_array
          path: "$[*]"
          each:
            channel_id: "const:${{get_live_json.principal_signal}}"
            title: "$.name"
            description: "$.descriptionShow|$.description"
            start_time: "$.dateTime"
            end_time: "$.dateFinishTime"
            image: "$.featured_image.url"
            is_live: "$.isLiveWeb"

    - name: "schedule_4"
      kind: Fetch
      url: "https://api.canal1.com.co/api/schedules/4"
      extract:
        programmes:
          kind: jsonpath_array
          path: "$[*]"
          each:
            channel_id: "const:${{get_live_json.principal_signal}}"
            title: "$.name"
            description: "$.descriptionShow|$.description"
            start_time: "$.dateTime"
            end_time: "$.dateFinishTime"
            image: "$.featured_image.url"
            is_live: "$.isLiveWeb"

    - name: "schedule_5"
      kind: Fetch
      url: "https://api.canal1.com.co/api/schedules/5"
      extract:
        programmes:
          kind: jsonpath_array
          path: "$[*]"
          each:
            channel_id: "const:${{get_live_json.principal_signal}}"
            title: "$.name"
            description: "$.descriptionShow|$.description"
            start_time: "$.dateTime"
            end_time: "$.dateFinishTime"
            image: "$.featured_image.url"
            is_live: "$.isLiveWeb"

    - name: "schedule_6"
      kind: Fetch
      url: "https://api.canal1.com.co/api/schedules/6"
      extract:
        programmes:
          kind: jsonpath_array
          path: "$[*]"
          each:
            channel_id: "const:${{get_live_json.principal_signal}}"
            title: "$.name"
            description: "$.descriptionShow|$.description"
            start_time: "$.dateTime"
            end_time: "$.dateFinishTime"
            image: "$.featured_image.url"
            is_live: "$.isLiveWeb"

content:
  headless: false
  proxy: "socks5://127.0.0.1:1080"

  outputs:
    manifest_url: "${{get_manifest.manifest_url}}"
    headers:
      Referer: "${{get_manifest.referer}}"
      Origin: "${{get_manifest.origin}}"
      Accept: "${{get_manifest.accept}}"
      Accept-Language: "${{get_manifest.accept_language}}"
      User-Agent: "${{get_manifest.user_agent}}"
      Cookie: "${{get_manifest.cookie}}"

  steps:
    - name: "go_to_livetv"
      kind: Navigate
      url: "https://www.canal1.com.co/senal-en-vivo/"
      wait_for:
        selector: "script#__NEXT_DATA__"

    - name: "start_player"
      kind: Automation
      steps:
        - kind: ClickIframe
          selector: "iframe"
          wait_for:
            delay: 0.5

    - name: "get_manifest"
      kind: Sniff
      request:
        url: "cdn\\.mdstrm\\.com/.*/media_1000\\.m3u8(\\?.*)?"
        timeout: 60.0
      extract:
        manifest_url:
          kind: url
        referer:
          kind: header
          path: "referer"
        origin:
          kind: header
          path: "origin"
        accept:
          kind: header
          path: "accept"
        accept_language:
          kind: header
          path: "accept-language"
        user_agent:
          kind: header
          path: "user-agent"
        cookie:
          kind: header
          path: "cookie"
